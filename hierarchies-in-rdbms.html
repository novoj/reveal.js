<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Modelování hierarchických struktur v relační databázi, 2020</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/clock.css">
    <link rel="stylesheet" href="css/theme/night.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!-- amCharts javascript sources -->
    <script type="text/javascript" src="https://www.amcharts.com/lib/3/amcharts.js"></script>
    <script type="text/javascript" src="https://www.amcharts.com/lib/3/serial.js"></script>
    <script type="text/javascript" src="https://www.amcharts.com/lib/3/themes/chalk.js"></script>

    <style>
        @media screen and (max-height: 1000px) {
            #logo {
                display: none;
                visibility: hidden;
            } }
    </style>
</head>

<body>

<div style="display: block; position: absolute; bottom: 40px; left: 50%; width: 1000px; margin-left: -500px; z-index: 20;">
    <table style="width: 100%">
        <tr>
            <td style="text-align: center; vertical-align: bottom; padding-top: 2px; width: 20%">
                <a href="http://www.fg.cz" target="_blank"><img src="img/javadayscz2020/FG_Forrest_neg.png" height="30px"/></a>
            </td>
            <td style="text-align: center; vertical-align: bottom; padding-top: 2px; width: 20%">
                <a href="http://www.fg.cz" target="_blank"><img src="img/javadayscz2020/edeeone.svg" height="30px"/></a>
            </td>
        </tr>
    </table>
</div>

<div class="reveal">

    <div class="slides">
        <!-- INTRO -->
        <section data-background="img/backgrounds/bridge.jpg">
            <h1 style="color: gold; margin-top: 0.5em; text-shadow: 0 1px 0 orange, 0 2px 0 goldenrod, 0 3px 0 goldenrod, 0 4px 0 goldenrod, 0 5px 0 orange, 0 6px 1px rgba(0, 0, 0, 0.1), 0 0 5px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.3), 0 3px 5px rgba(0, 0, 0, 0.2), 0 5px 10px rgba(0, 0, 0, 0.25), 0 20px 20px rgba(0, 0, 0, 0.15);">Modelování hierarchických struktur v relační databázi</h1>
            <p style="color: black; margin: 2em;">
                Jan <a style="color: whitesmoke" href="http://www.twiter.com/novoj">@Novoj</a> Novotný
            </p>
            <h4 style="color: orange">Online verze prezentace<br/><a style="color: goldenrod" href="http://bit.ly/javadays2020">http://bit.ly/javadays2020</a></h4>
        </section>
        <!-- ABOUT ME -->
        <section data-background="img/backgrounds/jno.jpg" data-background-size="contain" style="padding-left: 25%">
            <h4>
                <span style="font-size: 180%">Sledujte prezentaci se mnou</span><br/>
                <a href="http://bit.ly/javadays2020" style="font-size: 105%">http://bit.ly/javadays2020</a>
            </h4>
            <h4 style="margin-bottom: 1em;">
                <span style="font-size: 180%">Pohrejte si s kódem</span><br/>
                <a href="https://github.com/novoj/JavaDays2020" style="font-size: 105%">https://github.com/novoj/JavaDays2020.git</a>
            </h4>
            <h2>O mně</h2>
            <ul style="margin-left: 3em; margin-bottom: 1em;">
                <li>backend vývojář v <a href="https://www.fg.cz">FG Forrest</a></li>
                <li>organizátor <a href="https://www.jopenspace.cz">jOpenSpace</a> ne-konference</li>
                <li>spoluautor podcastu <a href="https://kafemlejnek.tv">Kafemlejnek.TV</a></li>
                <li>20 let vývojářem webových aplikací</li>
            </ul>
            <h4>Použití v e-commerce</h4>
            <ul style="margin-left: 3em; font-size: 70%;">
                <li><a href="https://www.senesi.cz">Senesi.cz (koupelny a kuchyně)</a></li>
                <li><a href="https://www.signal-nabytek.cz">Signál-nábytek.cz (vybavení domácnosti)</a></li>
                <li><a href="https://www.flangi.cz/">Flangi.cz (vybavení domácnosti)</a></li>
                <li><a href="https://www.warehouse1.cz">Warehouse1.cz (alkohol)</a></li>
                <li><a href="https://www.fjallraven-shop.cz">Fjallraven-Shop.cz (oblečení)</a></li>
            </ul>
        </section>
        <!-- PROBLEM AREA DESCRIPTION -->
        <section data-background="img/backgrounds/metalworking.jpg">
            <section data-transition="fade">
                <h2>Nejčastější použití</h2>
                <div style="text-align: center">
                    <p>Více-úrovňová menu (zobraz hierarchii).</p>
                    <img src="img/hierarchies-in-rdbms/senesi-menu.png" height="600px">
                </div>
            </section>
            <section data-transition="fade">
                <h2>Nejčastější použití</h2>
                <div style="text-align: center;">
                    <p>Drobečková navigace (vypiš nadřízené).</p>
                    <img src="img/hierarchies-in-rdbms/senesi-breadcrumb.png" height="600px">
                </div>
            </section>
            <section data-transition="fade">
                <h2>Nejčastější použití</h2>
                <div style="text-align: center">
                    <p>Výpis návazných produktů v omezené sekci stromu.</p>
                    <img src="img/hierarchies-in-rdbms/senesi-product-listing.png" height="600px">
                </div>
            </section>
        </section>
        <!-- NAIVE SOLUTION -->
        <section data-background="img/backgrounds/metalworking.jpg">
            <section>
                <h2 style="margin-bottom: 1em;">Reprezentace vazbou na rodiče</h2>
                <p>Naivní návrh datové struktury, byť hojně používaný v literatuře.</p>
                <div style="text-align: center">
                    <table style="width: 800px">
                        <tr>
                            <td style="vertical-align: top">
                                <pre><code class="sql" data-trim data-noescape>
CREATE TABLE category(
    category_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    parent INT DEFAULT NULL
);
                    </code></pre>
                            </td>
                            <td style="vertical-align: top">
                                <img src="img/hierarchies-in-rdbms/naive-rdm.png" height="200">
                            </td>
                        </tr>
                    </table>
                </div>
                <ul>
                    <li>ne všechny databáze podporují <a href="https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL">hierarchické dotazy</a></li>
                    <li>špatně implementovaná rekurze je na větších datech příliš pomalá</li>
                </ul>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Emulace reálného stavu</h2>
                <p>V praxi pracujeme s mnohem rozsáhlejšími daty a proto si pojďme devinovat situaci, která se alespoň
                    velmi vzdáleně podobá reálným případům z praxe.</p>
                <div style="text-align: center">
                    <img src="img/hierarchies-in-rdbms/real-life-example.png" width="600px">
                </div>
                <p>Ukážeme si reálné SQL dotazy nad Oracle 11g databází.</p>
                <p>Zkuste si je sami: <a href="https://github.com/novoj/JavaDays2020" style="font-size: 105%">https://github.com/novoj/JavaDays2020.git</a></p>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Hierarchické dotazy v Oracle DB</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S ALESPOŇ JEDNÍM PRODUKTEM V PODKATEGORIÍCH SEKCE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select distinct TC.* from T_CATEGORY TC

// přes M:N vazbu produktu na kategorii
     left join T_PRODUCT_CATEGORY TPC on TC.CATEGORY_ID = TPC.CATEGORY_ID
     left join T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// s vyloučením kategorií bez produktů
where TP.PRODUCT_ID is not null

// a hierarchickým dotazem od kategorie s ID = 2 s rekurzí přes podřízené
start with TC.CATEGORY_ID = 2
connect by prior TC.CATEGORY_ID = TC.PARENT;
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
1000 rows retrieved starting from 1 in 133 ms (execution: 9 ms, fetching: 124 ms)
                    </code></pre>
                </div>
                <p>
                    <small><strong>Zdroj:</strong> <a href="https://livesql.oracle.com/apex/livesql/file/tutorial_GQMLEEPG5ARVSIFGQRD3SES92.html">Oracle tutorial</a></small>
                </p>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Hierarchické dotazy v Oracle DB</h2>
                <h4  style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S ALESPOŇ JEDNÍM PRODUKTEM V PODKATEGORIÍCH SEKCE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
SELECT distinct t3.* FROM T_CATEGORY t1

// otrocky připojme X podřízených úrovní kategorií
         LEFT JOIN T_CATEGORY t2 ON t2.parent = t1.category_id
         LEFT JOIN T_CATEGORY t3 ON t3.parent = t2.category_id

// s M:N vazbou produktu na kategorii
         LEFT JOIN T_PRODUCT_CATEGORY TPC on t1.CATEGORY_ID = TPC.CATEGORY_ID OR t2.CATEGORY_ID = TPC.CATEGORY_ID OR t3.CATEGORY_ID = TPC.CATEGORY_ID
         LEFT JOIN T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// s vyloučením kategorií bez produktů a nastavením úvodní kategorie na ID = 2
where TP.PRODUCT_ID is not null
      and t1.CATEGORY_ID = 2
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
1000 rows retrieved starting from 1 in 148 ms (execution: 12 ms, fetching: 136 ms)
                    </code></pre>
                </div>
                <ul>
                    <li>špatně škáluje na velkých datech</li>
                    <li>limitováno na předem daný počet úrovní zanoření</li>
                    <li>nepraktické z více ohledů</li>
                </ul>
            </section>
            <section>
                <h2  style="margin-bottom: 1em;">Hierarchické dotazy v Oracle DB</h2>
                <h4  style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S POČTEM PRODUKTŮ V NICH</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape style="max-height: 500px">
// zajímají nás kategorie a počet produktů v nich
select TC.*, A.PRODUCT_COUNT from T_CATEGORY TC
 inner join (

// zde můžeme získat pouze sloupce, které jsou použité v GROUP by sekci
    select t1.CATEGORY_ID, count(0) as PRODUCT_COUNT
        from T_CATEGORY t1

// přes M:N vazbu produktu na kategorii
             left join T_PRODUCT_CATEGORY TPC on t1.CATEGORY_ID = TPC.CATEGORY_ID
             left join T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// s vyloučením kategorií bez produktů a nastavením úvodní kategorie na ID = 2
    where TP.PRODUCT_ID is not null
    start with t1.CATEGORY_ID = 2
    connect by prior t1.CATEGORY_ID = t1.PARENT

// seskupit podle kategorie
    group by t1.CATEGORY_ID
    having count(0) > 0

 ) a on a.CATEGORY_ID = TC.CATEGORY_ID
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
100 rows retrieved starting from 1 in 224 ms (execution: 153 ms, fetching: 71 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Hierarchické dotazy v Oracle DB</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ NADŘÍZENÉ KATEGORIE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select * from T_CATEGORY TC

// nadřízené kategorii s ID = 4
start with TC.CATEGORY_ID = 4

// s obrácenou rekurzivní vazbou
connect by prior TC.PARENT = TC.CATEGORY_ID;
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
5 rows retrieved starting from 1 in 63 ms (execution: 6 ms, fetching: 57 ms)
                    </code></pre>
                </div>
                <p>
                    <small><strong>Zdroj:</strong> <a href="https://livesql.oracle.com/apex/livesql/file/tutorial_GQMLEEPG5ARVSIFGQRD3SES92.html">Oracle tutorial</a></small>
                </p>
            </section>
        </section>
        <!-- TEXT BASED SOLUTION -->
        <section data-background="img/backgrounds/metalworking.jpg">
            <section>
                <h2 style="margin-bottom: 1em;">Reprezentace formou skládané cesty</h2>
                <div style="text-align: center">
                    <table style="width: 800px">
                        <tr>
                            <td style="vertical-align: middle">
                                <pre><code class="sql" data-trim data-noescape style="width: 450px">
CREATE TABLE category(
    category_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    path VARCHAR(512) DEFAULT '/'
);
                    </code></pre>
                            </td>
                            <td style="vertical-align: top">
                                <img src="img/hierarchies-in-rdbms/path-rdm.png" height="200px">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="text-align: center">
                                <h4>Ukázka dat</h4>
                                <img src="img/hierarchies-in-rdbms/composed-path-example.png">
                            </td>
                        </tr>
                    </table>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 2em;">Reprezentace formou skládané cesty</h2>
                <table>
                    <tr>
                        <th>Výhody</th>
                        <th>Nevýhody</th>
                    </tr>
                    <tr>
                        <td>
                            <ul>
                                <li>vyhneme se rekurzi</li>
                                <li>překvapivě relativně i rychlé i na větších datech</li>
                                <li>nadřízené položky jsou zakódované v cestě</li>
                            </ul>
                        </td>
                        <td>
                            <ul>
                                <li>vyžaduje větší prostor na disku</li>
                                <li>komplikovaně se udržuje při přesunech ve stromu</li>
                            </ul>
                        </td>
                    </tr>
                </table>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Reprezentace formou skládané cesty</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S ALESPOŇ JEDNÍM PRODUKTEM V PODKATEGORIÍCH SEKCE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select distinct TC.* from T_CATEGORY TC

// přes M:N vazbu produktu na kategorii
         left join T_PRODUCT_CATEGORY TPC on TC.CATEGORY_ID = TPC.CATEGORY_ID
         left join T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// s vyloučením kategorií bez produktů
where TP.PRODUCT_ID is not null

// jejichž cesta začíná cestou nadřízené kategorie
      and TC.PATH like '/0/1/2/%';
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
1000 rows retrieved starting from 1 in 108 ms (execution: 4 ms, fetching: 104 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Reprezentace formou skládané cesty</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S POČTEM PRODUKTŮ V NICH</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie a počet produktů v nich
select TC.*, A.PRODUCT_COUNT from T_CATEGORY TC
    inner join (

// zde můžeme získat pouze sloupce, které jsou použité v GROUP by sekci
        select T_CATEGORY.CATEGORY_ID, count(0) as PRODUCT_COUNT
        from T_CATEGORY

// přes M:N vazbu produktu na kategorii
                 left join T_PRODUCT_CATEGORY TPC on T_CATEGORY.CATEGORY_ID = TPC.CATEGORY_ID
                 left join T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// jejichž cesta začíná cestou nadřízené kategorie
        where TP.PRODUCT_ID is not null
              and T_CATEGORY.PATH like '/0/1/2/%'

// seskupit podle kategorie
        group by T_CATEGORY.CATEGORY_ID
        having count(0) > 0
    ) a on a.CATEGORY_ID = TC.CATEGORY_ID
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
100 rows retrieved starting from 1 in 144 ms (execution: 73 ms, fetching: 71 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Reprezentace formou skládané cesty</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ NADŘÍZENÉ KATEGORIE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select * from T_CATEGORY
    where CATEGORY_ID in (

// rozděl cestu na jednotlivé fragmenty
    select regexp_substr(a.PATH, '[^/]+', 1, level)
    from (

            // nadřízené kategorii s ID = 4
            select concat(PATH, concat('/', concat(CATEGORY_ID, '/'))) as PATH
                        from T_CATEGORY where CATEGORY_ID = 4
    ) a

// fragmenty převeď na řádkovou reprezentaci (černá magie)
    connect BY regexp_substr(a.PATH, '[^/]+', 1, level) is not null)

// setřídit podle úrovně zanoření sestupně
order by LVL desc;
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
5 rows retrieved starting from 1 in 111 ms (execution: 83 ms, fetching: 28 ms)
                    </code></pre>
                </div>
                <p>
                    <small><strong>Zdroj:</strong> <a href="https://livesql.oracle.com/apex/livesql/file/tutorial_GQMLEEPG5ARVSIFGQRD3SES92.html">Oracle tutorial</a></small>
                </p>
            </section>
        </section>
        <!-- MPTT SOLUTION -->
        <section data-background="img/backgrounds/metalworking.jpg">
            <section>
                <h2 style="margin-bottom: 1em;">Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <p>Odlišný pohled na hierarchická data formou do sebe zanořených množin.</p>
                <table>
                    <tr>
                        <td style="vertical-align: middle">
                            <img src="https://cloud.githubusercontent.com/assets/1818373/7474091/7d7f409a-f33f-11e4-9979-9a0fc566ac59.png"/>
                        </td>
                        <td style="vertical-align: middle; font-weight: bold; font-size: 220%; color: goldenrod; padding: 0;">&rightarrow;</td>
                        <td style="vertical-align: middle">
                            <img src="https://cloud.githubusercontent.com/assets/1818373/7474097/80c09c5e-f33f-11e4-8437-63c243791261.png" width="1200px"/>
                        </td>
                    </tr>
                </table>
            </section>
            <section>
                <h2>Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <p>U každého uzlu se definují levé a pravé hranice, které jsou větší než levé a pravé hranice všech jejich dětí.</p>
                <div style="text-align: center">
                    <img src="https://cloud.githubusercontent.com/assets/1818373/7474104/869870d4-f33f-11e4-8d40-76518a332bce.png"/>
                </div>
            </section>
            <section>
                <h2>Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <div style="text-align: center">
                    <p>Mapování v následující relační struktuře:</p>
                    <img src="img/hierarchies-in-rdbms/mptt-base.png"/>
                </div>
                <p>Získej všechny podřízené uzly konkrétního uzlu</p>
                <pre><code class="sql" data-trim data-noescape>
select * from MPTT where left >= node.left and right <= node.right
                </code></pre>
                <p>Získej všechny nadřízené uzly konkrétního uzlu</p>
                <pre><code class="sql" data-trim data-noescape>
select * from MPTT where left <= node.left and right => node.right
                </code></pre>
            </section>
            <section>
                <h2>Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <p>Pro další typy dotazů je vhodné rozšířit MPTT informace o úroveň zanoření a počet dětí.</p>
                <img src="img/hierarchies-in-rdbms/mptt-extended.png" style="float: left; width: 350px; margin-right: 40px; margin-top: 110px; margin-bottom: 60px"/>
                <p>Získej uzly podřízené konkrétního uzlu do hloubky Y</p>
                <pre><code class="sql" data-trim data-noescape>
select * from MPTT
         where left  >= node.left and
               right <= node.right and
               level >= node.level and
               level <= node.level + Y
                </code></pre>
                <p>Získej uzly nadřízené konkrétnímu uzlu do hloubky Y</p>
                <pre><code class="sql" data-trim data-noescape>
select * from MPTT
         where left <= node.left and
               right => node.right and
               level >= node.level and
               level <= node.level + Y
                </code></pre>
                <p>Získej všechny podřízené "koncové" uzly konkrétního uzlu</p>
                <pre><code class="sql" data-trim data-noescape>
select * from MPTT a
         where left <= node.left and
               right => node.right and
               node.numberOfChildren = 0
                </code></pre>
            </section>
            <section>
                <h2>Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <h3 style="margin-top: 1em;">Nevýhody</h3>
                <ol>
                    <li>zápisy do datové struktury jsou drahé.<br/>S každým zápisem je třeba zaktualizovat hranice ve velké části stromu.</li>
                    <li>zhoršená čitelnost pro vývojáře - z hranic není ihned patrné umístění ve stromu</li>
                </ol>
                <h3 style="margin-top: 1em;">Běžné operace se stromem:</h3>
                <ul>
                    <li>přidání nového uzlu</li>
                    <li>změna pořadí uzlu mezi "sourozenci"</li>
                    <li>odstranění uzlu</li>
                    <li>přesun uzlu včetně podstromu na jiné místo v hierarchii</li>
                </ul>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S ALESPOŇ JEDNÍM PRODUKTEM V PODKATEGORIÍCH SEKCE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select distinct TC.* from T_CATEGORY TC

// přes M:N vazbu produktu na kategorii
    left join T_PRODUCT_CATEGORY TPC on TC.CATEGORY_ID = TPC.CATEGORY_ID
    left join T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// pouze kategorie jejichž hranice leží uvnitř intevalu
where TC.LEFT >= 3 and TC.RIGHT <= 21052

// s vyloučením kategorií bez produktů
      and TP.PRODUCT_ID is not null;
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
1000 rows retrieved starting from 1 in 91 ms (execution: 5 ms, fetching: 86 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S ALESPOŇ JEDNÍM PRODUKTEM V PODKATEGORIÍCH SEKCE</h4>
                <p>Pokud de-normalizujeme strukturu tabulek a uložíme hranice blíže k produktu, potom:</p>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select distinct TC.* from T_CATEGORY TC

// s vazbou na produkty
    inner join T_PRODUCT TP on TC.LEFT = TP.LEFT and TC.RIGHT = TP.RIGHT

// jejichž hranice leží uvnitř intevalu
where TP.LEFT >= 3 and TP.RIGHT <= 21052
                    </code></pre>
                </div>
                <p><small>Poznámka: de-normalizací jsme zároveň porušili M:N vazbu, ale tento příklad je zde pouze pro ilustraci</small></p>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
1000 rows retrieved starting from 1 in 85 ms (execution: 4 ms, fetching: 81 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S POČTEM PRODUKTŮ V NICH</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie a počet produktů v nich
select TC.*, A.PRODUCT_COUNT from T_CATEGORY TC
    inner join (

// zde můžeme získat pouze sloupce, které jsou použité v GROUP by sekci
        select T_CATEGORY.CATEGORY_ID, count(0) as PRODUCT_COUNT
               from T_CATEGORY

// přes M:N vazbu produktu na kategorii
               left join T_PRODUCT_CATEGORY TPC on T_CATEGORY.CATEGORY_ID = TPC.CATEGORY_ID
               left join T_PRODUCT TP on TP.PRODUCT_ID = TPC.PRODUCT_ID

// jejichž hranice leží uvnitř intevalu
            where T_CATEGORY.LEFT >= 3 and T_CATEGORY.RIGHT <= 21052
                  and TP.PRODUCT_ID is not null

// seskupit podle kategorie
            group by T_CATEGORY.CATEGORY_ID
            having count(0) > 0
    ) a on a.CATEGORY_ID = TC.CATEGORY_ID
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
100 rows retrieved starting from 1 in 133 ms (execution: 49 ms, fetching: 84 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ KATEGORIE S POČTEM PRODUKTŮ V NICH</h4>
                <p>Pokud de-normalizujeme strukturu tabulek a uložíme hranice blíže k produktu, potom:</p>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie a počet produktů v nich
select TC.*, A.PRODUCT_COUNT from T_CATEGORY TC
    inner join (

// které se váží na hranice produktů
        select left, right, count(0) as PRODUCT_COUNT from T_PRODUCT TP

// jejichž hranice leží uvnitř intevalu
        where TP.LEFT >= 3 and TP.RIGHT <= 21052

// seskupeno dle hranic (pouze ty a počet nás zajímají)
        group by left, RIGHT

// sloučeno dle shodných hranic
    ) a on TC.LEFT = a.LEFT and TC.RIGHT = a.RIGHT
                    </code></pre>
                </div>
                <p><small>Poznámka: de-normalizací jsme zároveň porušili M:N vazbu, ale tento příklad je zde pouze pro ilustraci</small></p>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
100 rows retrieved starting from 1 in 143 ms (execution: 68 ms, fetching: 75 ms)
                    </code></pre>
                </div>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Modified Preorder Tree Traversal (MPTT) algoritmus</h2>
                <h4 style="color: goldenrod; margin-bottom: 1em;">VYPIŠ NADŘÍZENÉ KATEGORIE</h4>
                <div style="text-align: center">
                    <pre><code class="sql" data-trim data-noescape>
// zajímají nás kategorie
select TC.* from T_CATEGORY TC

// jejichž hranice obklopují hranice koncové kategorie
    where TC.LEFT <= 5 and TC.RIGHT >= 15

// setřídit podle úrovně zanoření sestupně
    order by LVL desc;
                    </code></pre>
                </div>
                <p>S přibližným výsledkem:</p>
                <div style="text-align: center">
                    <pre><code>
5 rows retrieved starting from 1 in 43 ms (execution: 4 ms, fetching: 39 ms)
                    </code></pre>
                </div>
                <p>
                    <small><strong>Zdroj:</strong> <a href="https://livesql.oracle.com/apex/livesql/file/tutorial_GQMLEEPG5ARVSIFGQRD3SES92.html">Oracle tutorial</a></small>
                </p>
            </section>
        </section>
        <section data-background="img/backgrounds/metalworking.jpg">
            <h2>Odezvy typizovaných dotazů</h2>
            <!-- amCharts javascript code -->
            <script type="text/javascript">
                AmCharts.makeChart("chartdiv",
                    {
                        "type": "serial",
                        "categoryField": "Typ dotazu",
                        "startDuration": 1,
                        "fontFamily": "Arial",
                        "fontSize": 14,
                        "theme": "chalk",
                        "categoryAxis": {
                            "gridPosition": "start",
                            "title": ""
                        },
                        "trendLines": [],
                        "graphs": [
                            {
                                "balloonText": "[[value]] ms",
                                "fillAlphas": 1,
                                "id": "AmGraph-1",
                                "title": "Hierarchický dotaz",
                                "type": "column",
                                "valueField": "Hierarchický dotaz"
                            },
                            {
                                "balloonText": "[[value]] ms",
                                "fillAlphas": 1,
                                "id": "AmGraph-2",
                                "title": "Skládaná cesta (like)",
                                "type": "column",
                                "valueField": "Skládaná cesta (like)"
                            },
                            {
                                "balloonText": "[[value]] ms",
                                "fillAlphas": 1,
                                "id": "AmGraph-3",
                                "title": "MPTT",
                                "type": "column",
                                "valueField": "MPTT"
                            },
                            {
                                "balloonText": "[[value]] ms",
                                "fillAlphas": 1,
                                "id": "AmGraph-4",
                                "title": "MPTT de-normalizovaný",
                                "type": "column",
                                "valueField": "MPTT de-normalizovaný"
                            }
                        ],
                        "guides": [],
                        "valueAxes": [
                            {
                                "id": "ValueAxis-1",
                                "title": "Odezva v ms"
                            }
                        ],
                        "allLabels": [],
                        "balloon": {
                            "borderAlpha": 0
                        },
                        "legend": {
                            "enabled": true,
                            "useGraphSettings": true
                        },
                        "dataProvider": [
                            {
                                "Hierarchický dotaz": "133",
                                "Skládaná cesta (like)": "140",
                                "MPTT": "133",
                                "MPTT de-normalizovaný": "153",
                                "Typ dotazu": "Kategorie v sekci s alespoň jedním produktem"
                            },
                            {
                                "Hierarchický dotaz": "224",
                                "Skládaná cesta (like)": "144",
                                "MPTT": "133",
                                "MPTT de-normalizovaný": "143",
                                "Typ dotazu": "Kategorie v sekci s počtem produtků"
                            },
                            {
                                "Hierarchický dotaz": "571",
                                "Skládaná cesta (like)": "347",
                                "MPTT": "302",
                                "MPTT de-normalizovaný": "163",
                                "Typ dotazu": "Produkty v sekci"
                            },
                            {
                                "Hierarchický dotaz": "63",
                                "Skládaná cesta (like)": "111",
                                "MPTT": "43",
                                "MPTT de-normalizovaný": "43",
                                "Typ dotazu": "Nadřízené kategorie"
                            }
                        ]
                    }
                );
            </script>
            <div id="chartdiv" style="height: 600px; background-color: #282828;" ></div>
            <p style="text-align: center">
                <small><strong>Měřeno na:</strong> Oracle 11g, Intel® Core™ i7-5600U CPU @ 2.60GHz × 4, RAM 32GB, Ubuntu 20.04</small><br/>
                <small>Absolutní hodnoty nemají smysl, klíčové v grafu jsou relativní vztahy.</small>
            </p>
        </section>
        <!-- PMPTT SOLUTION -->
        <section data-background="img/backgrounds/metalworking.jpg">
            <section>
                <h2 style="margin-bottom: 1em;">Precalculated Modified Preorder Tree Traversal (PMPTT) algoritmus</h2>
                <p>Pokus o odpověď na negativa MPTT algoritmu v oblasti změn ve stromě.</p>
                <ul>
                    <li>deterministicky přiřazuje hranice kategoriím dle pořadí jejich vzniku</li>
                    <li>pro kategorie na nižších úrovních jsou předem definované rozsahy "bucketů", které se postupně obsazují</li>
                    <li>pořadí bucketů není rozhodující, zavádí se nový sloupec "order"</li>
                </ul>
                <h4 style="margin-top: 1em;">Zavádí ovšem tři nové limitace:</h4>
                <ul>
                    <li>je nutné předem stanovit maximální počet uzlů v rámci nadřízeného uzlu</li>
                    <li>je nutné předem stanovit maximální počet zanořených úrovni</li>
                    <li>součet všech rozsahů na nejnižší úrovni musí být <= rozsah číselného datového typu</li>
                </ul>
            </section>
            <section>
                <h2>Prealokovaná struktura pro 3 úrovně o 2 položkách</h2>
                <p>Struktura je zprvu "virtuální" a postupně se zaplňuje reálnými daty:</p>
                <div style="text-align: center;">
                    <img src="img/hierarchies-in-rdbms/pmptt.png">
                </div>
                <p>Level 0 je limitován maximálním rozpětím datového typu Java Long. Tj. reálně např. 10 úrovní při
                    55 položkách. Toto množství by se dalo teoreticky dále rozšířit přechodem na unsigned long.</p>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Open source FTW!</h2>
                <p>PMPTT knihovna je dostupná pod MIT licencí v Maven Central:</p>
                <pre><code class="xml" data-trim data-noescape>
&lt;dependency&gt;
    &lt;groupId&gt;one.edee.oss&lt;/groupId&gt;
    &lt;artifactId&gt;lib_pmptt&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;one.edee.oss&lt;/groupId&gt;
    &lt;artifactId&gt;lib_pmptt_rdbms&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;
                </code></pre>
                <p>Dokumentace a zdrojové kódy jsou dostupné na GitHub:</p>
                <p><a href="https://github.com/FgForrest/PMPTT">https://github.com/FgForrest/PMPTT</a></p>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Open source FTW!</h2>
                <p>Použití v kódu:</p>
                <pre><code class="java" data-trim data-noescape style="max-height: 800px">
// create PMPTT instance
final PMPTT pmptt = new PMPTT(new MemoryStorage());

// PMPTT instance can handle several different "hierarchies" - ie. trees
final Hierarchy hierarchy = pmptt.getOrCreateHierarchy("eshopCategories", (short) 10, (short) 51);

// fill up hierarchy with categories
final HierarchyItem tvs = hierarchy.createRootItem("Televize");
final HierarchyItem washingMachines = hierarchy.createRootItem("Pračky");
final HierarchyItem cellPhones = hierarchy.createRootItem("Mobily");
final HierarchyItem lcd = hierarchy.createItem("LCD", tvs.getCode());

// bounds are automatically computed and accessible for attaching to de-normalized structures
final Long leftBound = tvs.getLeftBound();
final Long rightBound = tvs.getRightBound();

// all hierarchy modification operations are baked in
hierarchy.removeItem(cellPhones.getCode());
hierarchy.moveItemBetweenLevelsFirst(washingMachines.getCode(), tvs.getCode());

// you can list categories top-bottom
final List&lt;HierarchyItem&gt; childrens = hierarchy.getChildItems(tvs.getCode());
final List&lt;HierarchyItem&gt; leafs = hierarchy.getLeafItems(tvs.getCode());

// or bottom up
final List&lt;HierarchyItem&gt; parents = hierarchy.getParentItems(lcd.getCode());
                </code></pre>
            </section>
            <section>
                <h2 style="margin-bottom: 1em;">Open source FTW!</h2>
                <p>Podpora pro de-normalizované modely:</p>
                <pre><code class="java" data-trim data-noescape style="max-height: 800px">
// register callback for updating bounds in custom tables
pmptt.registerChangeListener(
	new HierarchyChangeListenerAdapter() {
		@Override
		public void itemUpdated(HierarchyItem updatedItem, HierarchyItem originalItem) {
			//update bounds in other tables
		}
	}
);
                </code></pre>
            </section>
        </section>
        <!-- OUTRO -->
        <section data-background="img/backgrounds/attention.jpg">
            <div style="display: inline-block; padding: 1em; background-color: rgba(0, 0, 0, 0.7);">
                <h1>Díky za pozornost</h1>
                <p><strong>Zdroje:</strong></p>
                <ul>
                    <li><a href="https://livesql.oracle.com/apex/livesql/file/tutorial_GQMLEEPG5ARVSIFGQRD3SES92.html">Oracle: Hierarchical Queries: Databases for Developers</a></li>
                    <li><a href="https://gist.github.com/tmilos/f2f999b5839e2d42d751">Milos Tomic: Modified Preorder Tree Traversal</a></li>
                    <li><a href="https://www.zdrojak.cz/serialy/ukladam/">Zdroják: Ukládáme hierarchická data v databázi (3 díly)</a></li>
                    <li><a href="https://github.com/FgForrest/PMPTT">Precalculated modified preorder tree traversal na GitHub</a></li>
                </ul>
                <p>Kontaktujte mě na <a target="_blank" href="https://www.twitter.com/novoj">@Novoj</a> nebo <a target="_blank" href="mailto:novotnaci@gmail.com">novotnaci@gmail.com</a></p>
            </div>
        </section>
    </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/clock.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>

    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        history: true,
        controls: true,
        progress: true,
        history: true,
        center: true,

        width: 1200,
        height: 900,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
            { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
            { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
            { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
    });
</script>

</body>
</html>